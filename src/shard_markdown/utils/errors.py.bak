"""Error handling and exception classes."""

from datetime import UTC, datetime

from ..types import MetadataDict


class ShardMarkdownError(Exception):
    """Base exception for all shard-markdown errors."""

    def __init__(
        self,
        message: str,
        error_code: int,
        category: str,
        context: MetadataDict | None = None,
        cause: Exception | None = None,
    ) -> None:
        """Initialize the ShardMarkdownError.

        Args:
            message: Error message description
            error_code: Unique error code for this error type
            category: Error category (e.g., INPUT, CONFIG, etc.)
            context: Additional context information
            cause: The original exception that caused this error
        """
        super().__init__(message)
        self.message = message
        self.error_code = error_code
        self.category = category
        self.context = context or {}
        self.cause = cause
        self.timestamp = datetime.now(UTC)

    def to_dict(self) -> MetadataDict:
        """Convert error to dictionary for logging/reporting."""
        return {
            "error_code": self.error_code,
            "category": self.category,
            "message": self.message,
            "context": self.context,
            "timestamp": self.timestamp.isoformat(),
            "cause": str(self.cause) if self.cause else None,
        }


class InputValidationError(ShardMarkdownError):
    """Errors related to invalid input validation."""

    def __init__(self, message: str, error_code: int = 1000, **kwargs) -> None:
        """Initialize the InputValidationError.

        Args:
            message: Error message description
            error_code: Unique error code (default 1000)
            **kwargs: Additional arguments passed to parent class
        """
        super().__init__(message, error_code, "INPUT", **kwargs)


class ConfigurationError(ShardMarkdownError):
    """Errors related to configuration issues."""

    def __init__(self, message: str, error_code: int = 1100, **kwargs) -> None:
        """Initialize the ConfigurationError.

        Args:
            message: Error message description
            error_code: Unique error code (default 1100)
            **kwargs: Additional arguments passed to parent class
        """
        super().__init__(message, error_code, "CONFIG", **kwargs)


class FileSystemError(ShardMarkdownError):
    """Errors related to file system operations."""

    def __init__(self, message: str, error_code: int = 1200, **kwargs) -> None:
        """Initialize the FileSystemError.

        Args:
            message: Error message description
            error_code: Unique error code (default 1200)
            **kwargs: Additional arguments passed to parent class
        """
        super().__init__(message, error_code, "FILESYSTEM", **kwargs)


class ProcessingError(ShardMarkdownError):
    """Errors during document processing."""

    def __init__(self, message: str, error_code: int = 1300, **kwargs) -> None:
        """Initialize the ProcessingError.

        Args:
            message: Error message description
            error_code: Unique error code (default 1300)
            **kwargs: Additional arguments passed to parent class
        """
        super().__init__(message, error_code, "PROCESSING", **kwargs)


class ChromaDBError(ShardMarkdownError):
    """Errors related to ChromaDB operations."""

    def __init__(self, message: str, error_code: int = 1400, **kwargs) -> None:
        """Initialize the ChromaDBError.

        Args:
            message: Error message description
            error_code: Unique error code (default 1400)
            **kwargs: Additional arguments passed to parent class
        """
        super().__init__(message, error_code, "CHROMADB", **kwargs)


class NetworkError(ShardMarkdownError):
    """Errors related to network operations."""

    def __init__(self, message: str, error_code: int = 1500, **kwargs) -> None:
        """Initialize the NetworkError.

        Args:
            message: Error message description
            error_code: Unique error code (default 1500)
            **kwargs: Additional arguments passed to parent class
        """
        super().__init__(message, error_code, "NETWORK", **kwargs)


class ParsingError(ShardMarkdownError):
    """Errors during markdown parsing."""

    def __init__(self, message: str, error_code: int = 1600, **kwargs) -> None:
        """Initialize the ParsingError.

        Args:
            message: Error message description
            error_code: Unique error code (default 1600)
            **kwargs: Additional arguments passed to parent class
        """
        super().__init__(message, error_code, "PARSING", **kwargs)


class ValidationError(InputValidationError):
    """Specific validation errors (inherits from InputValidationError)."""

    def __init__(self, message: str, field_name: str = "", **kwargs) -> None:
        """Initialize the ValidationError.

        Args:
            message: Error message description
            field_name: Name of the field that failed validation
            **kwargs: Additional arguments passed to parent class
        """
        context = kwargs.get("context", {})
        if field_name:
            context["field_name"] = field_name
        kwargs["context"] = context

        super().__init__(message, error_code=1001, **kwargs)


class ChromaDBConnectionError(ChromaDBError):
    """Specific connection errors for ChromaDB."""

    def __init__(self, message: str, **kwargs) -> None:
        """Initialize the ChromaDBConnectionError.

        Args:
            message: Error message description
            **kwargs: Additional arguments passed to parent class
        """
        super().__init__(message, error_code=1401, **kwargs)
