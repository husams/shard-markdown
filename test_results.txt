============================= test session starts ==============================
platform darwin -- Python 3.13.5, pytest-8.4.1, pluggy-1.6.0
benchmark: 5.1.0 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
rootdir: /Users/husam/workspace/tools/shard-markdown
configfile: pyproject.toml
testpaths: tests
plugins: anyio-4.9.0, asyncio-1.1.0, cov-6.2.1, mock-3.14.1, benchmark-5.1.0
asyncio: mode=Mode.STRICT, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 304 items

tests/e2e/test_cli_workflows.py FFF...FF.FF.F..F..F.FF                   [  7%]
tests/integration/test_document_processing.py ..F.......FFFF.....        [ 13%]
tests/performance/test_benchmarks.py .FF...F.F.FF                        [ 17%]
tests/unit/chromadb/test_client.py .F......................              [ 25%]
tests/unit/chromadb/test_collection_manager.py ......................... [ 33%]
.....                                                                    [ 35%]
tests/unit/chromadb/test_version_detector_simple.py ...........          [ 38%]
tests/unit/cli/test_main.py .......F...........F...                      [ 46%]
tests/unit/cli/test_process_command.py F..FFF.FFFFF....FFFF.F.F          [ 54%]
tests/unit/config/test_settings.py ....................F....             [ 62%]
tests/unit/core/test_models.py ......................................    [ 75%]
tests/unit/core/test_processor.py .........FF....F.......                [ 82%]
tests/unit/test_chunking.py ....F.F..                                    [ 85%]
tests/unit/test_parser.py ...F..F                                        [ 87%]
tests/unit/utils/test_errors.py .......................                  [ 95%]
tests/unit/utils/test_logging.py FF.......F....E                         [100%]

==================================== ERRORS ====================================
________ ERROR at teardown of test_log_context_record_factory_fallback _________
tests/fixtures/chromadb_fixtures.py:232: in chromadb_test_fixture
    fixture.teardown()
tests/fixtures/chromadb_fixtures.py:128: in teardown
    logger.info(f"Cleaning up {len(self._test_collections)} test collections")
/opt/homebrew/Cellar/python@3.13/3.13.5/Frameworks/Python.framework/Versions/3.13/lib/python3.13/logging/__init__.py:1522: in info
    self._log(INFO, msg, args, **kwargs)
/opt/homebrew/Cellar/python@3.13/3.13.5/Frameworks/Python.framework/Versions/3.13/lib/python3.13/logging/__init__.py:1667: in _log
    self.handle(record)
/opt/homebrew/Cellar/python@3.13/3.13.5/Frameworks/Python.framework/Versions/3.13/lib/python3.13/logging/__init__.py:1686: in handle
    self.callHandlers(record)
/opt/homebrew/Cellar/python@3.13/3.13.5/Frameworks/Python.framework/Versions/3.13/lib/python3.13/logging/__init__.py:1743: in callHandlers
    if record.levelno >= hdlr.level:
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: '>=' not supported between instances of 'int' and 'MagicMock'
--------------------------- Captured stderr teardown ---------------------------
[19:22:09] INFO     Cleaning up 3 test collections
=================================== FAILURES ===================================
_______ TestBasicCLIWorkflows.test_complete_document_processing_workflow _______
tests/e2e/test_cli_workflows.py:70: in test_complete_document_processing_workflow
    assert result.exit_code == 0
E   assert 1 == 0
E    +  where 1 = <Result SystemExit(1)>.exit_code
------------------------------ Captured log setup ------------------------------
WARNING  shard_markdown.tests.fixtures.chromadb_fixtures:chromadb_fixtures.py:114 ChromaDB connection attempt 1 failed: Could not connect to a Chroma server. Are you sure it is running?
WARNING  shard_markdown.tests.fixtures.chromadb_fixtures:chromadb_fixtures.py:114 ChromaDB connection attempt 2 failed: Could not connect to a Chroma server. Are you sure it is running?
WARNING  shard_markdown.tests.fixtures.chromadb_fixtures:chromadb_fixtures.py:114 ChromaDB connection attempt 3 failed: Could not connect to a Chroma server. Are you sure it is running?
WARNING  shard_markdown.tests.fixtures.chromadb_fixtures:chromadb_fixtures.py:119 Using mock ChromaDB client for tests
----------------------------- Captured stdout call -----------------------------
Process output: Processing 1 markdown files...
Error: Cannot connect to ChromaDB server: localhost:8000
Aborted!

_____________ TestBasicCLIWorkflows.test_batch_processing_workflow _____________
tests/e2e/test_cli_workflows.py:136: in test_batch_processing_workflow
    assert result.exit_code == 0
E   assert 1 == 0
E    +  where 1 = <Result SystemExit(1)>.exit_code
----------------------------- Captured stdout call -----------------------------
Batch process output: Processing 3 markdown files...
Error: Cannot connect to ChromaDB server: localhost:8000
Aborted!

__________ TestBasicCLIWorkflows.test_recursive_directory_processing ___________
tests/e2e/test_cli_workflows.py:160: in test_recursive_directory_processing
    assert result.exit_code == 0
E   assert 2 == 0
E    +  where 2 = <Result SystemExit(2)>.exit_code
----------------------------- Captured stdout call -----------------------------
Recursive process output: Usage: cli process [OPTIONS] INPUT_PATHS...
Try 'cli process --help' for help.

Error: No such option: --pattern

___________ TestAdvancedCLIWorkflows.test_custom_chunking_strategies ___________
tests/e2e/test_cli_workflows.py:313: in test_custom_chunking_strategies
    assert result.exit_code == 0
E   assert 1 == 0
E    +  where 1 = <Result SystemExit(1)>.exit_code
----------------------------- Captured stdout call -----------------------------
Chunking structure output: Processing 1 markdown files...
Error: Cannot connect to ChromaDB server: localhost:8000
Aborted!

_________ TestAdvancedCLIWorkflows.test_metadata_preservation_workflow _________
tests/e2e/test_cli_workflows.py:351: in test_metadata_preservation_workflow
    assert result.exit_code == 0
E   assert 2 == 0
E    +  where 2 = <Result SystemExit(2)>.exit_code
----------------------------- Captured stdout call -----------------------------
Metadata processing output: Usage: cli process [OPTIONS] INPUT_PATHS...
Try 'cli process --help' for help.

Error: No such option: --include-frontmatter

_________ TestAdvancedCLIWorkflows.test_concurrent_processing_workflow _________
tests/e2e/test_cli_workflows.py:408: in test_concurrent_processing_workflow
    assert result.exit_code == 0
E   assert 1 == 0
E    +  where 1 = <Result SystemExit(1)>.exit_code
----------------------------- Captured stdout call -----------------------------
Workers 1: 0.00s
Concurrent 1 output: Processing 3 markdown files...
Error: Cannot connect to ChromaDB server: localhost:8000
Aborted!

_______ TestAdvancedCLIWorkflows.test_large_document_processing_workflow _______
tests/e2e/test_cli_workflows.py:447: in test_large_document_processing_workflow
    assert result.exit_code == 0
E   assert 1 == 0
E    +  where 1 = <Result SystemExit(1)>.exit_code
----------------------------- Captured stdout call -----------------------------
Large document output: Processing 1 markdown files...
Error: Cannot connect to ChromaDB server: localhost:8000
Aborted!

____________ TestAdvancedCLIWorkflows.test_config_override_workflow ____________
tests/e2e/test_cli_workflows.py:522: in test_config_override_workflow
    assert result.exit_code == 0
E   assert 1 == 0
E    +  where 1 = <Result SystemExit(1)>.exit_code
----------------------------- Captured stdout call -----------------------------
Config override output: Processing 1 markdown files...
Error: Cannot connect to ChromaDB server: localhost:8000
Aborted!

_____________ TestAdvancedCLIWorkflows.test_file_pattern_filtering _____________
tests/e2e/test_cli_workflows.py:621: in test_file_pattern_filtering
    assert result.exit_code == 0
E   assert 2 == 0
E    +  where 2 = <Result SystemExit(2)>.exit_code
----------------------------- Captured stdout call -----------------------------
Pattern filtering output: Usage: cli process [OPTIONS] INPUT_PATHS...
Try 'cli process --help' for help.

Error: No such option: --pattern

____________ TestCLIErrorScenarios.test_permission_denied_scenarios ____________
tests/e2e/test_cli_workflows.py:713: in test_permission_denied_scenarios
    assert any(
E   assert False
E    +  where False = any(<generator object TestCLIErrorScenarios.test_permission_denied_scenarios.<locals>.<genexpr> at 0x109063d30>)
----------------------------- Captured stdout call -----------------------------
Permission denied output: Usage: cli process [OPTIONS] INPUT_PATHS...
Try 'cli process --help' for help.

Error: Invalid value for 'INPUT_PATHS...': Path '/var/folders/07/p__xlp357ps_8_fb3yhffmrh0000gn/T/tmp0bwz91do/restricted' is not readable.

__________ TestCLIPerformance.test_large_batch_processing_performance __________
tests/e2e/test_cli_workflows.py:821: in test_large_batch_processing_performance
    assert result.exit_code == 0
E   assert 1 == 0
E    +  where 1 = <Result SystemExit(1)>.exit_code
----------------------------- Captured stdout call -----------------------------
Performance test output: Processing 50 markdown files...
Error: Cannot connect to ChromaDB server: localhost:8000
Aborted!

Processing time: 0.00 seconds
__________ TestCLIPerformance.test_memory_usage_with_large_documents ___________
tests/e2e/test_cli_workflows.py:852: in test_memory_usage_with_large_documents
    assert result.exit_code == 0
E   assert 1 == 0
E    +  where 1 = <Result SystemExit(1)>.exit_code
----------------------------- Captured stdout call -----------------------------
Large document output: Processing 1 markdown files...
Error: Cannot connect to ChromaDB server: localhost:8000
Aborted!

______ TestDocumentProcessingIntegration.test_complex_markdown_structure _______
tests/integration/test_document_processing.py:123: in test_complex_markdown_structure
    assert result.chunks_created >= 3  # Should create multiple chunks
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   AssertionError: assert 1 >= 3
E    +  where 1 = ProcessingResult(file_path=PosixPath('/var/folders/07/p__xlp357ps_8_fb3yhffmrh0000gn/T/tmpwc6h81lw/complex.md'), succe...00141525268555, collection_name='complex-test', error=None, timestamp=datetime.datetime(2025, 8, 7, 18, 22, 2, 651934)).chunks_created
___________ TestDocumentProcessingErrors.test_file_permission_errors ___________
tests/integration/test_document_processing.py:434: in test_file_permission_errors
    assert result.success is False
E   AssertionError: assert True is False
E    +  where True = ProcessingResult(file_path=PosixPath('/var/folders/07/p__xlp357ps_8_fb3yhffmrh0000gn/T/tmpctss52a0/restricted.md'), su...1396484375, collection_name='test-permissions', error=None, timestamp=datetime.datetime(2025, 8, 7, 18, 22, 2, 687564)).success
----------------------------- Captured stderr call -----------------------------
[19:22:02] WARNING  Permission denied reading file:
                    /var/folders/07/p__xlp357ps_8_fb3yhffmrh0000gn/T/tmpctss52a0
                    /restricted.md
------------------------------ Captured log call -------------------------------
WARNING  shard_markdown.shard_markdown.core.processor:processor.py:299 Permission denied reading file: /var/folders/07/p__xlp357ps_8_fb3yhffmrh0000gn/T/tmpctss52a0/restricted.md
__________ TestDocumentProcessingErrors.test_corrupted_file_handling ___________
tests/integration/test_document_processing.py:464: in test_corrupted_file_handling
    assert result.success is False
E   AssertionError: assert True is False
E    +  where True = ProcessingResult(file_path=PosixPath('/var/folders/07/p__xlp357ps_8_fb3yhffmrh0000gn/T/tmpkvi51nhg/corrupted.md'), suc...391326904297, collection_name='corrupted-test', error=None, timestamp=datetime.datetime(2025, 8, 7, 18, 22, 2, 692129)).success
__________ TestDocumentProcessingErrors.test_very_large_file_handling __________
tests/integration/test_document_processing.py:483: in test_very_large_file_handling
    assert result.success is False
E   AssertionError: assert True is False
E    +  where True = ProcessingResult(file_path=PosixPath('/var/folders/07/p__xlp357ps_8_fb3yhffmrh0000gn/T/tmplg7t4x50/huge.md'), success=...01819133758544922, collection_name='huge-test', error=None, timestamp=datetime.datetime(2025, 8, 7, 18, 22, 2, 695101)).success
_________ TestDocumentProcessingErrors.test_nonexistent_file_handling __________
tests/integration/test_document_processing.py:494: in test_nonexistent_file_handling
    assert result.success is False
E   AssertionError: assert True is False
E    +  where True = ProcessingResult(file_path=PosixPath('does_not_exist.md'), success=True, chunks_created=0, processing_time=0.00032067298889160156, collection_name='nonexistent-test', error=None, timestamp=datetime.datetime(2025, 8, 7, 18, 22, 2, 697502)).success
----------------------------- Captured stderr call -----------------------------
           WARNING  File not found: does_not_exist.md
------------------------------ Captured log call -------------------------------
WARNING  shard_markdown.shard_markdown.core.processor:processor.py:233 File not found: does_not_exist.md
___________ TestProcessingBenchmarks.test_batch_processing_benchmark ___________
tests/performance/test_benchmarks.py:121: in test_batch_processing_benchmark
    assert results[4]["time"] <= results[1]["time"], (
E   AssertionError: Concurrency should improve performance
E   assert 0.019508209079504013 <= 0.019204209093004465
----------------------------- Captured stdout call -----------------------------

Batch Processing Benchmark Results:
Workers: 1
  Processing time: 0.019s
  Successful files: 10/10
  Total chunks: 100
  Throughput: 520.7 files/second
Workers: 2
  Processing time: 0.019s
  Successful files: 10/10
  Total chunks: 100
  Throughput: 532.6 files/second
Workers: 4
  Processing time: 0.020s
  Successful files: 10/10
  Total chunks: 100
  Throughput: 512.6 files/second
_____ TestProcessingBenchmarks.test_chunking_performance_by_size[500-100] ______
tests/performance/test_benchmarks.py:160: in test_chunking_performance_by_size
    chunk_process_time = processing_time / result.chunks_created * 1000
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   ZeroDivisionError: float division by zero
----------------------------- Captured stdout call -----------------------------

Chunk Size 500 (overlap 100) Results:
  Processing time: 0.011s
  Chunks created: 0
----------------------------- Captured stderr call -----------------------------
           ERROR    Failed to process
                    /var/folders/07/p__xlp357ps_8_fb3yhffmrh0000gn/T/tmpcebsto16
                    /chunk_size_test_500.md: Generated chunks exceed size limits
                    at positions: [1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23,
                    25, 27, 29, 31, 33, 35, 37, 39, 41, 43, 45, 47, 49, 51, 53,
                    55, 57, 59, 61, 63, 65, 67, 69, 71, 73, 75, 77, 79, 81, 83,
                    85, 87, 89, 91, 93, 95, 97, 99]
------------------------------ Captured log call -------------------------------
ERROR    shard_markdown.shard_markdown.core.processor:processor.py:114 Failed to process /var/folders/07/p__xlp357ps_8_fb3yhffmrh0000gn/T/tmpcebsto16/chunk_size_test_500.md: Generated chunks exceed size limits at positions: [1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23, 25, 27, 29, 31, 33, 35, 37, 39, 41, 43, 45, 47, 49, 51, 53, 55, 57, 59, 61, 63, 65, 67, 69, 71, 73, 75, 77, 79, 81, 83, 85, 87, 89, 91, 93, 95, 97, 99]
_____________ TestProcessingBenchmarks.test_memory_usage_benchmark _____________
tests/performance/test_benchmarks.py:227: in test_memory_usage_benchmark
    memory_per_chunk = max_memory_increase / result.chunks_created
                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   ZeroDivisionError: float division by zero
----------------------------- Captured stdout call -----------------------------

Memory Usage Benchmark Results:
  Baseline memory: 123.8 MB
  Max memory increase: 5.3 MB
  Average memory increase: 5.0 MB
----------------------------- Captured stderr call -----------------------------
           ERROR    Failed to process
                    /var/folders/07/p__xlp357ps_8_fb3yhffmrh0000gn/T/tmp6bwaer9u
                    /memory_test.md: Generated chunks exceed size limits at
                    positions: [1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23, 25,
                    27, 29, 31, 33, 35, 37, 39, 41, 43, 45, 47, 49, 51, 53, 55,
                    57, 59, 61, 63, 65, 67, 69, 71, 73, 75, 77, 79, 81, 83, 85,
                    87, 89, 91, 93, 95, 97, 99, 101, 103, 105, 107, 109, 111,
                    113, 115, 117, 119, 121, 123, 125, 127, 129, 131, 133, 135,
                    137, 139, 141, 143, 145, 147, 149, 151, 153, 155, 157, 159,
                    161, 163, 165, 167, 169, 171, 173, 175, 177, 179, 181, 183,
                    185, 187, 189, 191, 193, 195, 197, 199, 201, 203, 205, 207,
                    209, 211, 213, 215, 217, 219, 221, 223, 225, 227, 229, 231,
                    233, 235, 237, 239, 241, 243, 245, 247, 249, 251, 253, 255,
                    257, 259, 261, 263, 265, 267, 269, 271, 273, 275, 277, 279,
                    281, 283, 285, 287, 289, 291, 293, 295, 297, 299, 301, 303,
                    305, 307, 309, 311, 313, 315, 317, 319, 321, 323, 325, 327,
                    329, 331, 333, 335, 337, 339, 341, 343, 345, 347, 349, 351,
                    353, 355, 357, 359, 361, 363, 365, 367, 369, 371, 373, 375,
                    377, 379, 381, 383, 385, 387, 389, 391, 393, 395, 397, 399]
------------------------------ Captured log call -------------------------------
ERROR    shard_markdown.shard_markdown.core.processor:processor.py:114 Failed to process /var/folders/07/p__xlp357ps_8_fb3yhffmrh0000gn/T/tmp6bwaer9u/memory_test.md: Generated chunks exceed size limits at positions: [1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21, 23, 25, 27, 29, 31, 33, 35, 37, 39, 41, 43, 45, 47, 49, 51, 53, 55, 57, 59, 61, 63, 65, 67, 69, 71, 73, 75, 77, 79, 81, 83, 85, 87, 89, 91, 93, 95, 97, 99, 101, 103, 105, 107, 109, 111, 113, 115, 117, 119, 121, 123, 125, 127, 129, 131, 133, 135, 137, 139, 141, 143, 145, 147, 149, 151, 153, 155, 157, 159, 161, 163, 165, 167, 169, 171, 173, 175, 177, 179, 181, 183, 185, 187, 189, 191, 193, 195, 197, 199, 201, 203, 205, 207, 209, 211, 213, 215, 217, 219, 221, 223, 225, 227, 229, 231, 233, 235, 237, 239, 241, 243, 245, 247, 249, 251, 253, 255, 257, 259, 261, 263, 265, 267, 269, 271, 273, 275, 277, 279, 281, 283, 285, 287, 289, 291, 293, 295, 297, 299, 301, 303, 305, 307, 309, 311, 313, 315, 317, 319, 321, 323, 325, 327, 329, 331, 333, 335, 337, 339, 341, 343, 345, 347, 349, 351, 353, 355, 357, 359, 361, 363, 365, 367, 369, 371, 373, 375, 377, 379, 381, 383, 385, 387, 389, 391, 393, 395, 397, 399]
_______ TestProcessingBenchmarks.test_concurrent_processing_scalability ________
tests/performance/test_benchmarks.py:350: in test_concurrent_processing_scalability
    assert efficiency_ratio > 0.5, (
E   AssertionError: Efficiency degraded too much: 0.12
E   assert 0.12247233426146828 > 0.5
----------------------------- Captured stdout call -----------------------------

Concurrent Processing Scalability Results:
  Workers: 1
    Processing time: 0.067s
    Efficiency: 299.536 files/second/worker
  Workers: 2
    Processing time: 0.067s
    Efficiency: 148.922 files/second/worker
  Workers: 4
    Processing time: 0.068s
    Efficiency: 73.910 files/second/worker
  Workers: 8
    Processing time: 0.068s
    Efficiency: 36.685 files/second/worker
_______________ TestMemoryEfficiency.test_memory_leak_detection ________________
tests/performance/test_benchmarks.py:473: in test_memory_leak_detection
    result = processor.process_document(doc_path, f"leak-test-{i}")
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/shard_markdown/core/processor.py:73: in process_document
    chunks = self.chunker.chunk_document(ast)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/shard_markdown/core/chunking/engine.py:44: in chunk_document
    strategy_name = self.config.method
                    ^^^^^^^^^^^^^^^^^^
E   AttributeError: 'dict' object has no attribute 'method'
____________ TestMemoryEfficiency.test_large_file_memory_efficiency ____________
tests/performance/test_benchmarks.py:522: in test_large_file_memory_efficiency
    result = processor.process_document(large_file, "large-file-memory-test")
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/shard_markdown/core/processor.py:73: in process_document
    chunks = self.chunker.chunk_document(ast)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/shard_markdown/core/chunking/engine.py:44: in chunk_document
    strategy_name = self.config.method
                    ^^^^^^^^^^^^^^^^^^
E   AttributeError: 'dict' object has no attribute 'method'
___________________ TestChromaDBClient.test_connect_success ____________________
tests/unit/chromadb/test_client.py:84: in test_connect_success
    client.version_detector.detect_api_version.return_value = mock_version_info  # type: ignore[attr-defined]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   AttributeError: 'method' object has no attribute 'return_value' and no __dict__ for setting new attributes
__________________ TestCLIMain.test_cli_config_loading_error ___________________
tests/unit/cli/test_main.py:105: in test_cli_config_loading_error
    assert "Error initializing" in result.output
E   AssertionError: assert 'Error initializing' in ''
E    +  where '' = <Result Exception('Config error')>.output
_______________ TestCLIErrorHandling.test_logging_error_handling _______________
tests/unit/cli/test_main.py:278: in test_logging_error_handling
    assert "Error initializing shard-md" in result.output
E   AssertionError: assert 'Error initializing shard-md' in ''
E    +  where '' = <Result Exception('Logging error')>.output
________________ TestProcessCommand.test_process_command_basic _________________
tests/unit/cli/test_process_command.py:65: in test_process_command_basic
    assert result.exit_code == 0
E   assert 1 == 0
E    +  where 1 = <Result TypeError("'NoneType' object is not subscriptable")>.exit_code
________ TestProcessCommand.test_process_command_custom_chunk_settings _________
tests/unit/cli/test_process_command.py:120: in test_process_command_custom_chunk_settings
    assert result.exit_code == 0
E   assert 1 == 0
E    +  where 1 = <Result TypeError("'NoneType' object is not subscriptable")>.exit_code
_______________ TestProcessCommand.test_process_command_dry_run ________________
tests/unit/cli/test_process_command.py:141: in test_process_command_dry_run
    assert result.exit_code == 0
E   assert 1 == 0
E    +  where 1 = <Result TypeError("'NoneType' object is not subscriptable")>.exit_code
______________ TestProcessCommand.test_process_command_recursive _______________
tests/unit/cli/test_process_command.py:172: in test_process_command_recursive
    assert result.exit_code == 0
E   assert 1 == 0
E    +  where 1 = <Result TypeError("'NoneType' object is not subscriptable")>.exit_code
__________ TestProcessCommand.test_process_command_create_collection ___________
tests/unit/cli/test_process_command.py:232: in test_process_command_create_collection
    assert result.exit_code == 0
E   assert 1 == 0
E    +  where 1 = <Result TypeError("'NoneType' object is not subscriptable")>.exit_code
__________ TestProcessCommand.test_process_command_failed_processing ___________
tests/unit/cli/test_process_command.py:255: in test_process_command_failed_processing
    assert "failed" in result.output.lower() or "error" in result.output.lower()
E   assert ('failed' in '' or 'error' in '')
E    +  where '' = <built-in method lower of str object at 0x104f5b318>()
E    +    where <built-in method lower of str object at 0x104f5b318> = ''.lower
E    +      where '' = <Result TypeError("'NoneType' object is not subscriptable")>.output
E    +  and   '' = <built-in method lower of str object at 0x104f5b318>()
E    +    where <built-in method lower of str object at 0x104f5b318> = ''.lower
E    +      where '' = <Result TypeError("'NoneType' object is not subscriptable")>.output
______ TestProcessCommand.test_process_command_chromadb_connection_error _______
tests/unit/cli/test_process_command.py:274: in test_process_command_chromadb_connection_error
    assert (
E   assert ('connection' in '' or 'failed' in '')
E    +  where '' = <built-in method lower of str object at 0x104f5b318>()
E    +    where <built-in method lower of str object at 0x104f5b318> = ''.lower
E    +      where '' = <Result TypeError("'NoneType' object is not subscriptable")>.output
E    +  and   '' = <built-in method lower of str object at 0x104f5b318>()
E    +    where <built-in method lower of str object at 0x104f5b318> = ''.lower
E    +      where '' = <Result TypeError("'NoneType' object is not subscriptable")>.output
___________ TestProcessCommand.test_process_command_validation_error ___________
tests/unit/cli/test_process_command.py:296: in test_process_command_validation_error
    assert "invalid" in result.output.lower()
E   assert 'invalid' in ''
E    +  where '' = <built-in method lower of str object at 0x104f5b318>()
E    +    where <built-in method lower of str object at 0x104f5b318> = ''.lower
E    +      where '' = <Result TypeError("'NoneType' object is not subscriptable")>.output
___________ TestProcessCommand.test_process_command_progress_display ___________
tests/unit/cli/test_process_command.py:321: in test_process_command_progress_display
    assert result.exit_code == 0
E   assert 1 == 0
E    +  where 1 = <Result TypeError("'NoneType' object is not subscriptable")>.exit_code
_ TestProcessCommand.test_process_command_chunk_parameter_combinations[500-100] _
tests/unit/cli/test_process_command.py:439: in test_process_command_chunk_parameter_combinations
    assert result.exit_code == 0
E   assert 1 == 0
E    +  where 1 = <Result TypeError("'NoneType' object is not subscriptable")>.exit_code
_ TestProcessCommand.test_process_command_chunk_parameter_combinations[1000-200] _
tests/unit/cli/test_process_command.py:439: in test_process_command_chunk_parameter_combinations
    assert result.exit_code == 0
E   assert 1 == 0
E    +  where 1 = <Result TypeError("'NoneType' object is not subscriptable")>.exit_code
_ TestProcessCommand.test_process_command_chunk_parameter_combinations[1500-300] _
tests/unit/cli/test_process_command.py:439: in test_process_command_chunk_parameter_combinations
    assert result.exit_code == 0
E   assert 1 == 0
E    +  where 1 = <Result TypeError("'NoneType' object is not subscriptable")>.exit_code
_ TestProcessCommand.test_process_command_chunk_parameter_combinations[2000-400] _
tests/unit/cli/test_process_command.py:439: in test_process_command_chunk_parameter_combinations
    assert result.exit_code == 0
E   assert 1 == 0
E    +  where 1 = <Result TypeError("'NoneType' object is not subscriptable")>.exit_code
_ TestProcessCommandEdgeCases.test_process_command_with_special_characters_in_path _
tests/unit/cli/test_process_command.py:495: in test_process_command_with_special_characters_in_path
    assert result.exit_code == 0
E   assert 1 == 0
E    +  where 1 = <Result TypeError("'NoneType' object is not subscriptable")>.exit_code
_____ TestProcessCommandEdgeCases.test_process_command_empty_markdown_file _____
tests/unit/cli/test_process_command.py:531: in test_process_command_empty_markdown_file
    assert "empty" in result.output.lower() or "failed" in result.output.lower()
E   assert ('empty' in '' or 'failed' in '')
E    +  where '' = <built-in method lower of str object at 0x104f5b318>()
E    +    where <built-in method lower of str object at 0x104f5b318> = ''.lower
E    +      where '' = <Result TypeError("'NoneType' object is not subscriptable")>.output
E    +  and   '' = <built-in method lower of str object at 0x104f5b318>()
E    +    where <built-in method lower of str object at 0x104f5b318> = ''.lower
E    +      where '' = <Result TypeError("'NoneType' object is not subscriptable")>.output
______________ TestConfigValidationScenarios.test_extreme_values _______________
tests/unit/config/test_settings.py:324: in test_extreme_values
    chunking_config = ChunkingConfig(default_size=100000)
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   pydantic_core._pydantic_core.ValidationError: 1 validation error for ChunkingConfig
E   default_size
E     Input should be less than or equal to 10000 [type=less_than_equal, input_value=100000, input_type=int]
E       For further information visit https://errors.pydantic.dev/2.9/v/less_than_equal
__________ TestDocumentProcessor.test_process_document_parsing_error ___________
tests/unit/core/test_processor.py:234: in test_process_document_parsing_error
    result = processor.process_document(sample_markdown_file, "test-collection")
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/shard_markdown/core/processor.py:66: in process_document
    ast = self.parser.parse(content)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
/opt/homebrew/Cellar/python@3.13/3.13.5/Frameworks/Python.framework/Versions/3.13/lib/python3.13/unittest/mock.py:1169: in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/opt/homebrew/Cellar/python@3.13/3.13.5/Frameworks/Python.framework/Versions/3.13/lib/python3.13/unittest/mock.py:1173: in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/opt/homebrew/Cellar/python@3.13/3.13.5/Frameworks/Python.framework/Versions/3.13/lib/python3.13/unittest/mock.py:1228: in _execute_mock_call
    raise effect
E   Exception: Parsing failed
__________ TestDocumentProcessor.test_process_document_encoding_error __________
tests/unit/core/test_processor.py:250: in test_process_document_encoding_error
    assert result.success is False
E   AssertionError: assert True is False
E    +  where True = ProcessingResult(file_path=PosixPath('/var/folders/07/p__xlp357ps_8_fb3yhffmrh0000gn/T/tmp408d7jp7/invalid_encoding.md...84020996094, collection_name='test-collection', error=None, timestamp=datetime.datetime(2025, 8, 7, 18, 22, 9, 591550)).success
_________ TestDocumentProcessor.test_batch_processing_partial_failure __________
tests/unit/core/test_processor.py:389: in test_batch_processing_partial_failure
    result = processor.process_batch(file_paths, "test-collection", max_workers=1)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/shard_markdown/core/processor.py:144: in process_batch
    results = self._execute_concurrent_processing(
src/shard_markdown/core/processor.py:175: in _execute_concurrent_processing
    results.append(future.result())
                   ^^^^^^^^^^^^^^^
/opt/homebrew/Cellar/python@3.13/3.13.5/Frameworks/Python.framework/Versions/3.13/lib/python3.13/concurrent/futures/_base.py:449: in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
/opt/homebrew/Cellar/python@3.13/3.13.5/Frameworks/Python.framework/Versions/3.13/lib/python3.13/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/opt/homebrew/Cellar/python@3.13/3.13.5/Frameworks/Python.framework/Versions/3.13/lib/python3.13/concurrent/futures/thread.py:59: in run
    result = self.fn(*self.args, **self.kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/shard_markdown/core/processor.py:66: in process_document
    ast = self.parser.parse(content)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
/opt/homebrew/Cellar/python@3.13/3.13.5/Frameworks/Python.framework/Versions/3.13/lib/python3.13/unittest/mock.py:1169: in __call__
    return self._mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/opt/homebrew/Cellar/python@3.13/3.13.5/Frameworks/Python.framework/Versions/3.13/lib/python3.13/unittest/mock.py:1173: in _mock_call
    return self._execute_mock_call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/opt/homebrew/Cellar/python@3.13/3.13.5/Frameworks/Python.framework/Versions/3.13/lib/python3.13/unittest/mock.py:1234: in _execute_mock_call
    result = effect(*args, **kwargs)
             ^^^^^^^^^^^^^^^^^^^^^^^
tests/unit/core/test_processor.py:380: in side_effect
    raise Exception("Processing failed")
E   Exception: Processing failed
----------------------------- Captured stderr call -----------------------------
           WARNING  No chunks generated for
                    /var/folders/07/p__xlp357ps_8_fb3yhffmrh0000gn/T/tmp383w6xjz
                    /simple.md
------------------------------ Captured log call -------------------------------
WARNING  shard_markdown.shard_markdown.core.processor:processor.py:76 No chunks generated for /var/folders/07/p__xlp357ps_8_fb3yhffmrh0000gn/T/tmp383w6xjz/simple.md
_______________ TestChunkingEngine.test_invalid_chunking_method ________________
tests/unit/test_chunking.py:82: in test_invalid_chunking_method
    engine.chunk_document(ast)
src/shard_markdown/core/chunking/engine.py:46: in chunk_document
    raise ProcessingError(
E   shard_markdown.utils.errors.ProcessingError: Unknown chunking strategy: invalid_method
____________ TestStructureAwareChunker.test_code_block_preservation ____________
tests/unit/test_chunking.py:141: in test_code_block_preservation
    assert code_chunk.content.count("```") == 2
E   assert 4 == 2
E    +  where 4 = <built-in method count of str object at 0x10907d6b0>('```')
E    +    where <built-in method count of str object at 0x10907d6b0> = '# Code Example\n\nHere\'s a long code block:\n\n```python\n```python\ndef very_long_function_name():\n    # This is a...t")\n    print("And even more content to make it really long")\n    return "A very long return value string"\n```\n```'.count
E    +      where '# Code Example\n\nHere\'s a long code block:\n\n```python\n```python\ndef very_long_function_name():\n    # This is a...t")\n    print("And even more content to make it really long")\n    return "A very long return value string"\n```\n```' = DocumentChunk(id=None, content='# Code Example\n\nHere\'s a long code block:\n\n```python\n```python\ndef very_long_fu...nk_size_config': 100, 'overlap_config': 200, 'structural_context': 'Code Example'}, start_position=0, end_position=426).content
_____________________ TestMarkdownParser.test_parse_lists ______________________
tests/unit/test_parser.py:107: in test_parse_lists
    assert len(lists) >= 2
E   assert 0 >= 2
E    +  where 0 = len([])
_____________ TestMarkdownParser.test_parse_malformed_frontmatter ______________
tests/unit/test_parser.py:171: in test_parse_malformed_frontmatter
    ast = parser.parse(content)
          ^^^^^^^^^^^^^^^^^^^^^
src/shard_markdown/core/parser.py:39: in parse
    post = frontmatter.loads(content)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.13/site-packages/frontmatter/__init__.py:185: in loads
    metadata, content = parse(text, encoding, handler, **defaults)
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.13/site-packages/frontmatter/__init__.py:92: in parse
    fm_data = handler.load(fm)
              ^^^^^^^^^^^^^^^^
venv/lib/python3.13/site-packages/frontmatter/default_handlers.py:260: in load
    return yaml.load(fm, **kwargs)  # type: ignore[arg-type]
           ^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.13/site-packages/yaml/__init__.py:81: in load
    return loader.get_single_data()
           ^^^^^^^^^^^^^^^^^^^^^^^^
venv/lib/python3.13/site-packages/yaml/constructor.py:49: in get_single_data
    node = self.get_single_node()
           ^^^^^^^^^^^^^^^^^^^^^^
yaml/_yaml.pyx:673: in yaml._yaml.CParser.get_single_node
    ???
yaml/_yaml.pyx:687: in yaml._yaml.CParser._compose_document
    ???
yaml/_yaml.pyx:731: in yaml._yaml.CParser._compose_node
    ???
yaml/_yaml.pyx:845: in yaml._yaml.CParser._compose_mapping_node
    ???
yaml/_yaml.pyx:694: in yaml._yaml.CParser._compose_node
    ???
yaml/_yaml.pyx:860: in yaml._yaml.CParser._parse_next_event
    ???
E   yaml.scanner.ScannerError: while scanning a quoted scalar
E     in "<unicode string>", line 2, column 8
E   found unexpected end of stream
E     in "<unicode string>", line 4, column 1
_______________________ test_setup_logging_console_only ________________________
/opt/homebrew/Cellar/python@3.13/3.13.5/Frameworks/Python.framework/Versions/3.13/lib/python3.13/unittest/mock.py:979: in assert_called_with
    raise AssertionError(_error_message()) from cause
E   AssertionError: expected call not found.
E   Expected: setLevel(10)
E     Actual: setLevel(30)

During handling of the above exception, another exception occurred:
tests/unit/utils/test_logging.py:22: in test_setup_logging_console_only
    mock_logger.setLevel.assert_called_with(logging.DEBUG)
E   AssertionError: expected call not found.
E   Expected: setLevel(10)
E     Actual: setLevel(30)
E
E   pytest introspection follows:
E
E   Args:
E   assert (30,) == (10,)
E
E     At index 0 diff: 30 != 10
E     Use -v to get more diff
_________________________ test_setup_logging_with_file _________________________
/opt/homebrew/Cellar/python@3.13/3.13.5/Frameworks/Python.framework/Versions/3.13/lib/python3.13/unittest/mock.py:979: in assert_called_with
    raise AssertionError(_error_message()) from cause
E   AssertionError: expected call not found.
E   Expected: setLevel(20)
E     Actual: setLevel(30)

During handling of the above exception, another exception occurred:
tests/unit/utils/test_logging.py:39: in test_setup_logging_with_file
    mock_logger.setLevel.assert_called_with(logging.INFO)
E   AssertionError: expected call not found.
E   Expected: setLevel(20)
E     Actual: setLevel(30)
E
E   pytest introspection follows:
E
E   Args:
E   assert (30,) == (20,)
E
E     At index 0 diff: 30 != 20
E     Use -v to get more diff
_______________________ test_log_context_record_factory ________________________
tests/unit/utils/test_logging.py:167: in test_log_context_record_factory
    assert hasattr(record, "user_id")
E   assert False
E    +  where False = hasattr(<LogRecord: test, 20, test.py, 1, "Test message">, 'user_id')
=============================== warnings summary ===============================
venv/lib/python3.13/site-packages/pydantic/_internal/_config.py:291
  /Users/husam/workspace/tools/shard-markdown/venv/lib/python3.13/site-packages/pydantic/_internal/_config.py:291: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.9/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

tests/e2e/test_cli_workflows.py: 16 warnings
tests/integration/test_document_processing.py: 1 warning
tests/performance/test_benchmarks.py: 2 warnings
tests/unit/chromadb/test_client.py: 11 warnings
tests/unit/chromadb/test_collection_manager.py: 20 warnings
tests/unit/core/test_processor.py: 2 warnings
tests/unit/test_chunking.py: 1 warning
tests/unit/utils/test_errors.py: 29 warnings
  /Users/husam/workspace/tools/shard-markdown/src/shard_markdown/utils/errors.py:33: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    self.timestamp = datetime.utcnow()

tests/integration/test_document_processing.py: 61 warnings
tests/performance/test_benchmarks.py: 3852 warnings
  /Users/husam/workspace/tools/shard-markdown/src/shard_markdown/core/metadata.py:166: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    enhanced["processed_at"] = datetime.utcnow().isoformat()

tests/integration/test_document_processing.py: 28 warnings
tests/performance/test_benchmarks.py: 131 warnings
tests/unit/cli/test_process_command.py: 18 warnings
tests/unit/core/test_models.py: 9 warnings
tests/unit/core/test_processor.py: 27 warnings
  /Users/husam/workspace/tools/shard-markdown/venv/lib/python3.13/site-packages/pydantic/main.py:212: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    validated_self = self.__pydantic_validator__.validate_python(data, self_instance=self)

tests/performance/test_benchmarks.py::TestProcessingBenchmarks::test_chunking_performance_by_size[1000-200]
  /Users/husam/workspace/tools/shard-markdown/venv/lib/python3.13/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but tests/performance/test_benchmarks.py::TestProcessingBenchmarks::test_chunking_performance_by_size[1000-200] returned <class 'dict'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

tests/performance/test_benchmarks.py::TestProcessingBenchmarks::test_chunking_performance_by_size[1500-300]
  /Users/husam/workspace/tools/shard-markdown/venv/lib/python3.13/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but tests/performance/test_benchmarks.py::TestProcessingBenchmarks::test_chunking_performance_by_size[1500-300] returned <class 'dict'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

tests/performance/test_benchmarks.py::TestProcessingBenchmarks::test_chunking_performance_by_size[2000-400]
  /Users/husam/workspace/tools/shard-markdown/venv/lib/python3.13/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but tests/performance/test_benchmarks.py::TestProcessingBenchmarks::test_chunking_performance_by_size[2000-400] returned <class 'dict'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
ERROR tests/unit/utils/test_logging.py::test_log_context_record_factory_fallback
FAILED tests/e2e/test_cli_workflows.py::TestBasicCLIWorkflows::test_complete_document_processing_workflow
FAILED tests/e2e/test_cli_workflows.py::TestBasicCLIWorkflows::test_batch_processing_workflow
FAILED tests/e2e/test_cli_workflows.py::TestBasicCLIWorkflows::test_recursive_directory_processing
FAILED tests/e2e/test_cli_workflows.py::TestAdvancedCLIWorkflows::test_custom_chunking_strategies
FAILED tests/e2e/test_cli_workflows.py::TestAdvancedCLIWorkflows::test_metadata_preservation_workflow
FAILED tests/e2e/test_cli_workflows.py::TestAdvancedCLIWorkflows::test_concurrent_processing_workflow
FAILED tests/e2e/test_cli_workflows.py::TestAdvancedCLIWorkflows::test_large_document_processing_workflow
FAILED
